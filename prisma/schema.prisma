generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PartnerType {
  COMPANY
  INDIVIDUAL
}

enum RegistrationType {
  LLP
  PVT_LTD
  OPC
  PARTNERSHIP
  OTHER
}

enum DocumentType {
  AADHAAR_FRONT
  AADHAAR_BACK
  PAN
  INCORPORATION_CERT
  MOA
  AOA
  BOARD_RESOLUTION
  OTHER
}

enum OwnerType {
  COMPANY
  INDIVIDUAL
}

enum OrderStatus {
  DRAFT
  DOCUMENT_PENDING
  UNDER_REVIEW
  SUBMITTED
  APPROVED
  REJECTED
  CANCELLED
}

enum OrderType {
  INDIVIDUAL
  GROUP
}

// -----------------------------------------------------
// PARTNER ACCOUNT
// -----------------------------------------------------

model PartnerAccount {
  id                 String   @id @default(uuid())
  partner_account_id String   @default(uuid())
  partner_type       PartnerType
  email              String   @unique
  password_hash      String
  is_active          Boolean  @default(true)
  kyc_verified       Boolean  @default(false)

  company_profile    CompanyProfile?
  individual_profile IndividualProfile?

  orders             Order[]

  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt
}

// -----------------------------------------------------
// COMPANY PROFILE
// -----------------------------------------------------

model CompanyProfile {
  id                   String        @id @default(uuid())
  company_profile_id   String        @default(uuid())

  company_name         String
  registration_type    RegistrationType
  contact_person_name  String
  contact_person_email String
  contact_person_phone String
  aadhaar_number       String?
  pan_number           String?
  incorporation_number String?
  incorporation_date   DateTime?
  registered_address   String?
  kyc_verified_at      DateTime?

  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  partner              PartnerAccount @relation(fields: [id], references: [id])
  kyc_documents        KycDocument[] @relation("CompanyKycDocuments")
}

// -----------------------------------------------------
// INDIVIDUAL PROFILE
// -----------------------------------------------------

model IndividualProfile {
  id                      String    @id @default(uuid())
  individual_profile_id   String    @default(uuid())

  full_name               String
  phone                   String
  aadhaar_number          String?
  pan_number              String?
  date_of_birth           DateTime?
  nationality_id          String?

  nationality             Country?  @relation("IndividualNationality", fields: [nationality_id], references: [id])

  kyc_verified_at         DateTime?
  created_at              DateTime @default(now())
  updated_at              DateTime @updatedAt

  partner                 PartnerAccount @relation(fields: [id], references: [id])
  kyc_documents           KycDocument[] @relation("IndividualKycDocuments")
}

// -----------------------------------------------------
// KYC DOCUMENT
// -----------------------------------------------------

model KycDocument {
  id                  String      @id @default(uuid())
  kyc_document_id     String      @default(uuid())

  owner_type          OwnerType
  owner_id            String
  document_type       DocumentType
  file_url            String
  is_mandatory        Boolean     @default(false)
  verification_status String?
  verification_notes  String?
  uploaded_at         DateTime    @default(now())
  verified_at         DateTime?

  company_owner       CompanyProfile?    @relation("CompanyKycDocuments", fields: [owner_id], references: [id], map: "kyc_document_company_owner_fkey")
  individual_owner    IndividualProfile? @relation("IndividualKycDocuments", fields: [owner_id], references: [id], map: "kyc_document_individual_owner_fkey")
}

// -----------------------------------------------------
// COUNTRY
// -----------------------------------------------------

model Country {
  id                   String   @id @default(uuid())
  country_id           String   @default(uuid())

  iso_code             String   @unique
  name                 String
  is_active            Boolean  @default(true)
  default_currency     String?

  visa_types           VisaType[]
  traveller_nationals  IndividualProfile[] @relation("IndividualNationality")

  visa_fees            VisaFee[]
  orders               Order[]
  order_travellers     OrderTraveller[]

  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt
}

// -----------------------------------------------------
// VISA TYPE
// -----------------------------------------------------

model VisaType {
  id                 String   @id @default(uuid())
  visa_type_id       String   @default(uuid())

  country_id         String
  code               String?
  name               String
  category           String?
  description        String?
  processing_days    Int?
  is_active          Boolean @default(true)

  country            Country    @relation(fields: [country_id], references: [id])
  visa_fees          VisaFee[]
  required_documents VisaRequiredDocument[]
  orders             Order[]

  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt
}

// -----------------------------------------------------
// VISA FEE
// -----------------------------------------------------

model VisaFee {
  id                     String   @id @default(uuid())
  visa_fee_id            String   @default(uuid())

  visa_type_id           String
  nationality_country_id String?
  base_fee_amount        Float
  currency               String
  service_fee_amount     Float?
  tax_amount             Float?
  valid_from             DateTime?
  valid_to               DateTime?

  visa_type              VisaType @relation(fields: [visa_type_id], references: [id])
  nationality            Country? @relation(fields: [nationality_country_id], references: [id])

  created_at             DateTime @default(now())
  updated_at             DateTime @updatedAt
}

// -----------------------------------------------------
// VISA REQUIRED DOCUMENT
// -----------------------------------------------------

model VisaRequiredDocument {
  id                           String   @id @default(uuid())
  visa_required_document_id    String   @default(uuid())

  visa_type_id                 String
  document_code                String
  document_name                String
  description                  String?
  is_mandatory                 Boolean @default(true)
  allowed_file_types           String?
  max_file_size_mb             Int?

  visa_type                    VisaType @relation(fields: [visa_type_id], references: [id])
  traveller_documents          OrderTravellerDocument[]

  created_at                  DateTime @default(now())
  updated_at                  DateTime @updatedAt
}

// -----------------------------------------------------
// ORDER
// -----------------------------------------------------

model Order {
  id              String      @id @default(uuid())
  order_id        String      @default(uuid())

  partner_id      String
  visa_type_id    String
  country_id      String
  order_type      OrderType
  status          OrderStatus @default(DOCUMENT_PENDING)
  total_fee_amount Float?
  fee_currency     String?
  group_name       String?
  travel_dates     String? // JSON string or comma-separated dates

  partner         PartnerAccount @relation(fields: [partner_id], references: [id])
  visa_type       VisaType       @relation(fields: [visa_type_id], references: [id])
  country         Country        @relation(fields: [country_id], references: [id])

  travellers      OrderTraveller[]
  documents       OrderTravellerDocument[]

  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
}

// -----------------------------------------------------
// ORDER TRAVELLER
// -----------------------------------------------------

model OrderTraveller {
  id                     String   @id @default(uuid())
  order_traveller_id     String   @default(uuid())

  order_id               String
  is_primary_applicant   Boolean  @default(false)
  full_name              String
  date_of_birth          DateTime?
  nationality_id         String?
  passport_number        String?
  passport_issue_date    DateTime?
  passport_expiry_date   DateTime?
  email                  String?
  phone                  String?

  order                  Order     @relation(fields: [order_id], references: [id])
  nationality            Country?  @relation(fields: [nationality_id], references: [id])
  documents              OrderTravellerDocument[]

  created_at             DateTime @default(now())
  updated_at             DateTime @updatedAt
}

// -----------------------------------------------------
// ORDER TRAVELLER DOCUMENT
// -----------------------------------------------------

enum OcrStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model OrderTravellerDocument {
  id                           String   @id @default(uuid())
  order_traveller_document_id  String   @default(uuid())

  order_id                     String
  traveller_id                 String?
  required_document_id         String
  file_url                     String
  verification_status          String?
  verification_notes           String?
  uploaded_at                  DateTime @default(now())
  verified_at                  DateTime?

  ocr_status                   OcrStatus?
  ocr_job_id                   String?
  ocr_extracted_data           Json?

  order            Order                @relation(fields: [order_id], references: [id])
  traveller        OrderTraveller?      @relation(fields: [traveller_id], references: [id])
  required_document VisaRequiredDocument @relation(fields: [required_document_id], references: [id])
}

